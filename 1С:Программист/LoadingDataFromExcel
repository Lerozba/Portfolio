// Команда очистки таблицы с товарами
&НаКлиенте
Процедура Очистить(Команда)
	Объект.Товары.Очистить();
	ВидимостьКнопкиСформировать();
КонецПроцедуры

// Команда Загрузить - загрузка данных из файла в таблицу товаров на форме обработки
&НаКлиенте
Процедура Загрузить(Команда)
	Объект.Товары.Очистить(); //на всякий случай предварительно очищаем таблицу
	ЗагрузитьНаСервере();     //запускаем серверную процедуру загрузки
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьНаСервере()
	// Создаем новый табличный документ
	ТабДокумент = Новый ТабличныйДокумент;
	// Пытаемся его прочитать
	Попытка
		ТабДокумент.Прочитать(Объект.ПутьКФайлу, СпособЧтенияЗначенийТабличногоДокумента.Значение);	
	Исключение
	    Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не удалось прочитать файл. Причина: " + ОписаниеОшибки();
		Сообщение.Сообщить();
		Возврат;
	КонецПопытки;
	// Определяем количество строк в файле
	КоличествоСтрок = ТабДокумент.ВысотаТаблицы;
	// Обходим в цикле все строки по номерам со 2 по последнюю
	// и записываем данные в табличную часть формы обработки
	Для НомерСтр = 2 По КоличествоСтрок Цикл
		СтрДанных = Объект.Товары.Добавить();
		СтрДанных.НаименованиеТовара = ТабДокумент.ПолучитьОбласть("R" + Формат(НомерСтр, "ЧГ=0") + "C" + 1).ТекущаяОбласть.Текст;
	    СтрДанных.Цена = ТабДокумент.ПолучитьОбласть("R" + Формат(НомерСтр, "ЧГ=0") + "C" + 2).ТекущаяОбласть.Текст;
	КонецЦикла;
КонецПроцедуры

// Команда Сформировать - заполнение справочника Номенклатура недостающими позициями и
// создание документа ЗаказТовараПоставщику   
&НаКлиенте
Процедура Сформировать(Команда)
	СформироватьНаСервере();
КонецПроцедуры

&НаСервере
Процедура СформироватьНаСервере() 
	// На первом этапе дозаполним недостающими позициями наш справочник Номенклатура
	// Создаем массив из данных табличной части формы обработки
	МассивНоменклатура = Новый Массив;
	Для каждого СтрокаДанных Из Объект.Товары Цикл
		МассивНоменклатура.Добавить(СтрокаДанных.НаименованиеТовара);
	КонецЦикла;  
	
	// 
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Ссылка В(&МассивНоменклатура)";
	
	Запрос.УстановитьПараметр("МассивНоменклатура", МассивНоменклатура);
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаНоменклатуры = РезультатЗапроса.Выгрузить();
	
	// Проходим в цикле по всем строкам табличной части формы
	// если наименование товара есть в нашем справочнике - пропускаем его, если нет - добавляем в справочник
	СчетчикДобавленныхПозиций = 0;
	Для каждого СтрДанных Из Объект.Товары Цикл
		НайденнаяСсылка = Справочники.Номенклатура.НайтиПоНаименованию(СтрДанных.НаименованиеТовара);
		Если НайденнаяСсылка <> Справочники.Номенклатура.ПустаяСсылка() Тогда
		    Продолжить;		
		КонецЕсли;
		НоваяНоменклатура = Справочники.Номенклатура.СоздатьЭлемент();
		НоваяНоменклатура.Наименование = СтрДанных.НаименованиеТовара;
		НоваяНоменклатура.Записать();
		Сообщить("В справочник ""Номенклатура"" внесен новый элемент - " + СтрДанных.НаименованиеТовара); 
		СчетчикДобавленныхПозиций = СчетчикДобавленныхПозиций + 1;
	КонецЦикла;
	
	Сообщить("******************");
	Сообщить("Создано " + СчетчикДобавленныхПозиций + " новых элементов справочника ""Номенклатура""");
	Сообщить("******************");  
	
	// На втором этапе сформируем документ  
	НовыйДокумент = Документы.ЗаказТоваровПоставщику.СоздатьДокумент();
	// заполним реквизиты документа
	НовыйДокумент.Дата = ТекущаяДата();
	НовыйДокумент.Поставщик = Объект.Поставщик;
	НовыйДокумент.Ответственный = Объект.Ответственный;
	НовыйДокумент.Комментарий = "Документ создан обработкой ""Загрузка данных из Excel"""; 
	НовыйДокумент.СуммаДокумента = Объект.Товары.Итог("Сумма");
	// заполним табличную часть только теми товарами, количество которых > 0
	Для каждого СтрокаДанных Из Объект.Товары Цикл
		Если СтрокаДанных.Количество > 0 Тогда
			СтрокаНовогоДокумента = НовыйДокумент.Товары.Добавить();
			СтрокаНовогоДокумента.НаименованиеТовара = Справочники.Номенклатура.НайтиПоНаименованию(СтрокаДанных.НаименованиеТовара);
			СтрокаНовогоДокумента.Количество = СтрокаДанных.Количество;	
			СтрокаНовогоДокумента.Цена = СтрокаДанных.Цена;
		    СтрокаНовогоДокумента.Сумма = СтрокаДанных.Сумма;
		КонецЕсли;
	КонецЦикла;
	НовыйДокумент.Записать();
	
	// данные о созданном документе разместим на форме обработки
	Объект.Документ = НовыйДокумент.Ссылка;
	Сообщить("Создан новый документ " + НовыйДокумент);
КонецПроцедуры

